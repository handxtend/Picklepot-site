<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Payment cancelled — PiCo Pickle Pot</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f7f7fb;color:#111}
    .wrap{max-width:760px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.06);padding:22px}
    .muted{color:#6b7280}
    .ok{color:#0a7a2e} .err{color:#b00020}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // Expect firebaseConfig to be injected globally the same way as index/manage.
    // Fallback config here in case the global isn't present.
    const fallbackConfig = {
      apiKey:"AIzaSyA9QcJizDv1ibAPI7FV_NY8cMhkCjokzXE",
      authDomain:"pickle-pot.firebaseapp.com",
      projectId:"pickle-pot",
      storageBucket:"pickle-pot.appspot.com",
      messagingSenderId:"508555645160",
      appId:"1:508555645160:web:82e09803feb83d5150395d"
    };
    try{
      if(!window.firebaseConfig) window.firebaseConfig = fallbackConfig;
      if(!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
    }catch(e){}
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Checkout cancelled</h2>
      <p class="muted">We didn't charge you. You can close this tab or go back to select a different payment method.</p>
      <p id="status" class="muted">Cleaning up your draft entry…</p>
    </div>
  </div>

<script>
(async function(){
  const $ = (id)=>document.getElementById(id);
  const db = firebase.firestore();

  // Helpers
  const qs = new URLSearchParams(location.search);
  const pot = qs.get('pot') || (function(){ try{ return (JSON.parse(localStorage.getItem('pp_last_draft'))||{}).potId }catch(_){ return null } })();
  const entry = qs.get('entry') || (function(){ try{ return (JSON.parse(localStorage.getItem('pp_last_draft'))||{}).entryId }catch(_){ return null } })();
  const statusEl = $('status');

  async function deleteIfDraft(potId, entryId){
    const ref = db.collection('pots').doc(potId).collection('entries').doc(entryId);
    const snap = await ref.get();
    if(!snap.exists){ return 'already-gone'; }
    const data = snap.data() || {};
    const st = (data.status || 'draft').toLowerCase();
    const paid = !!data.paid;
    // Only delete if it was a draft / not paid
    if(st === 'draft' || (!paid && st !== 'active')){
      await ref.delete();
      return 'deleted';
    }
    return 'kept';
  }

  try{
    if(pot && entry){
      const res = await deleteIfDraft(pot, entry);
      if(res === 'deleted'){
        statusEl.textContent = 'Draft removed.';
        statusEl.className = 'ok';
      }else if(res === 'already-gone'){
        statusEl.textContent = 'Nothing to clean up.';
        statusEl.className = 'muted';
      }else{
        statusEl.textContent = 'Entry was not a draft; left unchanged.';
        statusEl.className = 'muted';
      }
    }else{
      statusEl.textContent = 'Missing pot or entry id — nothing to clean up.';
      statusEl.className = 'muted';
    }
  }catch(e){
    console.error(e);
    statusEl.textContent = 'Could not clean up draft (you may ignore this).';
    statusEl.className = 'err';
  }finally{
    try{ localStorage.removeItem('pp_last_draft'); }catch(_){}
  }
})();
</script>
</body>
</html>
