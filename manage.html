<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Organizer — Manage Pot</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f7f7fb;color:#111}
    .wrap{max-width:920px;margin:40px auto;padding:0 16px}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.06);overflow:hidden}
    header{padding:20px 22px;border-bottom:1px solid #eee}
    header h1{margin:0;font-size:28px}
    .sec{padding:20px 22px}
    label{display:block;margin:10px 0 6px;color:#666}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #d8dbe2}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:#0d6efd;color:#fff;cursor:pointer}
    .btn.secondary{background:#111827}
    .hidden{display:none}
    .ok{color:#0a7a2e}
    .err{color:#b00020}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left}
  </style>
  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
  // firebase config (same as index), with guards
  const firebaseConfig = window.firebaseConfig || {
    apiKey: "AIzaSyA9QcJizDv1ibAPI7FV_NY8cMhkCjokzXE",
    authDomain: "pickle-pot.firebaseapp.com",
    projectId: "pickle-pot",
    storageBucket: "pickle-pot.appspot.com",
    messagingSenderId: "508555645160",
    appId: "1:508555645160:web:82e09803feb83d5150395d"
  };
  try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    if (firebase.auth) firebase.auth().signInAnonymously().catch(()=>{});
  } catch (e) { console.warn("Firebase init error:", e); }
  </script>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <header>
        <h1>Organizer — Manage Pot</h1>
        <p>Use the Owner Link (from the success page) <em>or</em> Owner Code to unlock your pot.</p>
      </header>
      <div class="sec">
        <label>Pot ID</label>
        <input id="pot-id" placeholder="e.g., abc123" />

        <label>Owner Link Key (from manage URL)</label>
        <input id="owner-key" placeholder="paste &key=… or full manage link" />

        <label>Owner Code (alternative auth)</label>
        <input id="owner-code" placeholder="e.g., 9X7BP" />

        <div class="row" style="margin-top:10px">
          <button id="verify" class="btn">Verify Access</button>
          <span id="status"></span>
        </div>
      </div>

      <div id="tools" class="sec hidden">
        <h3>Pot is unlocked</h3>
        <p id="potline" style="margin-top:-6px;color:#666"></p>
        <div id="entries"></div>
        <div class="row" style="margin-top:14px">
          <button id="rotate-code" class="btn secondary">Rotate Owner Code</button>
          <button id="rotate-link" class="btn secondary">Rotate Owner Link</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const API = (window.API_BASE || 'https://picklepot-stripe.onrender.com').replace(/\/$/, '');
  const $ = (id)=>document.getElementById(id);
  const msg = (t, ok)=>{ const el=$('status'); el.textContent=t; el.className = ok ? 'ok':'err'; };

  // Extract key if a full manage URL is pasted
  function normalizeKey(v){
    if (!v) return null;
    v=String(v).trim();
    const m = v.match(/[?&]key=([^&#]+)/i);
    return m ? decodeURIComponent(m[1]) : v;
  }

  async function ownerAuth(pot_id, key, code){
    const r = await fetch(`${API}/pots/${encodeURIComponent(pot_id)}/owner/auth`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ key: key||null, code: code||null })
    });
    if (!r.ok) throw new Error(await r.text().catch(()=>r.statusText));
    return r.json().catch(()=>({ok:true}));
  }

  // Live entries & Paid toggle
  let unsubscribe = null;
  function startLive(pot_id){
    try{ if (!firebase?.apps?.length) firebase.initializeApp(firebaseConfig); }catch(_){}
    const db = firebase.firestore();
    const box = $('entries');
    if (unsubscribe) { try{unsubscribe()}catch(_){ } unsubscribe = null; }
    box.innerHTML = '<em>Loading…</em>';
    unsubscribe = db.collection('pots').doc(pot_id).collection('entries').onSnapshot(snap => {
      const rows = [];
      snap.forEach(doc => {
        const e = doc.data() || {};
        if (e.status && e.status !== 'active') return;
        rows.push(`<tr>
          <td>${(e.name||e.player_name||'').replace(/[<>]/g,'')}</td>
          <td>${(e.email||e.player_email||'').replace(/[<>]/g,'')}</td>
          <td>${e.member_type||'Member'}</td>
          <td><button class="paid-toggle" data-id="${doc.id}">${e.paid?'Yes':'No'}</button></td>
        </tr>`);
      });
      box.innerHTML = `<table class="table">
        <thead><tr><th>Name</th><th>Email</th><th>Type</th><th>Paid</th></tr></thead>
        <tbody>${rows.join('')}</tbody>
      </table>`;
      box.querySelectorAll('.paid-toggle').forEach(btn => {
        btn.onclick = async (ev) => {
          const entryId = ev.currentTarget.getAttribute('data-id');
          const key = normalizeKey($('owner-key').value);
          const code = (($('owner-code').value||'').trim()||'').toUpperCase() || null;
          try{
            await fetch(`${API}/pots/${encodeURIComponent(pot_id)}/owner/entries/${encodeURIComponent(entryId)}/toggle-paid`, {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ key, code })
            });
          }catch(e){ console.error(e); alert('Toggle failed'); }
        };
      });
    }, err => {
      console.error('snapshot error', err);
      box.innerHTML = '<em>Error loading entries.</em>';
    });
  }

  // URL autofill
  try{
    const p = new URLSearchParams(location.search);
    if (p.get('pot')) $('pot-id').value = p.get('pot');
    if (p.get('key')) $('owner-key').value = p.get('key');
  }catch(_){}

  // Verify click
  $('verify').onclick = async () => {
    const pot = ($('pot-id').value||'').trim();
    const key = normalizeKey($('owner-key').value);
    const code = (($('owner-code').value||'').trim()||'').toUpperCase() || null;
    if (!pot){ msg('Enter a Pot ID.', false); return; }
    msg('Verifying…', true);
    try{
      await ownerAuth(pot, key, code);
      msg('Access granted.', true);
      $('tools').classList.remove('hidden');
      $('potline').textContent = `Pot ID: ${pot}`;
      localStorage.setItem('mgr_auth', JSON.stringify({pot, key, code}));
      startLive(pot);
      $('rotate-code').onclick = async () => {
        const r = await fetch(`${API}/pots/${encodeURIComponent(pot)}/owner/rotate-code`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ key, code })
        });
        const data = await r.json().catch(()=>({}));
        alert(data.new_code ? `New owner code: ${data.new_code}` : 'Owner code rotated.');
      };
      $('rotate-link').onclick = async () => {
        const r = await fetch(`${API}/pots/${encodeURIComponent(pot)}/owner/rotate-link`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ key, code })
        });
        const data = await r.json().catch(()=>({}));
        if (data.manage_url) {
          try{ await navigator.clipboard.writeText(data.manage_url); }catch(_){}
          alert('New manage link copied to clipboard.');
        } else {
          alert('Manage link rotated.');
        }
      };
    }catch(e){
      console.error(e);
      msg('Access denied. Check Pot ID and owner credentials.', false);
      $('tools').classList.add('hidden');
    }
  };

  // Auto-restore on refresh
  try{
    const saved = JSON.parse(localStorage.getItem('mgr_auth')||'null');
    if (saved && saved.pot && (saved.key || saved.code)){
      $('pot-id').value = saved.pot;
      $('owner-key').value = saved.key || '';
      $('owner-code').value = saved.code || '';
      setTimeout(()=> $('verify').click(), 50);
    }
  }catch(_){}
})();
</script>
</body>
</html>
