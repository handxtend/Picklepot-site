<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Organizer — Manage Pot</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f7f7fb;color:#111}
    .wrap{max-width:920px;margin:40px auto;padding:0 16px}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.06);overflow:hidden}
    header{padding:20px 22px;border-bottom:1px solid #eee}
    header h1{margin:0;font-size:28px}
    .sec{padding:20px 22px}
    label{display:block;margin:10px 0 6px;color:#666}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #d8dbe2}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:#0d6efd;color:#fff;cursor:pointer}
    .btn.secondary{background:#111827}
    .hidden{display:none}
    .ok{color:#0a7a2e}
    .err{color:#b00020}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left}
    .muted{color:#6b7280}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = window.firebaseConfig || {
      apiKey:"AIzaSyA9QcJizDv1ibAPI7FV_NY8cMhkCjokzXE",
      authDomain:"pickle-pot.firebaseapp.com",
      projectId:"pickle-pot",
      storageBucket:"pickle-pot.appspot.com",
      messagingSenderId:"508555645160",
      appId:"1:508555645160:web:82e09803feb83d5150395d"
    };
    try{ if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
         firebase.auth().signInAnonymously().catch(()=>{});}catch(e){}
  </script>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <header>
      <h1>Organizer — Manage Pot</h1>
      <p class="muted">Use the Owner Link (from the success page) or Owner Code to unlock your pot.</p>
    </header>
    <div class="sec">
      <label>Pot ID</label>
      <input id="pot-id" placeholder="e.g., abc123">
      <label>Owner Link Key (from manage URL)</label>
      <input id="owner-key" placeholder="paste &key=… or full manage link">
      <label>Owner Code (alternative auth)</label>
      <input id="owner-code" placeholder="e.g., 9X7BP">
      <div class="row" style="margin-top:10px">
        <button id="verify" class="btn">Verify Access</button>
        <span id="status"></span>
      </div>
    </div>
    <div id="tools" class="sec hidden">
      <h3>Pot is unlocked</h3>
      <p id="potline" class="muted"></p>
      <div id="entries"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const API = (window.API_BASE || 'https://picklepot-stripe.onrender.com').replace(/\/$/,'');
  const $ = (id)=>document.getElementById(id);
  const setMsg = (t, ok)=>{ const el=$('status'); el.textContent=t; el.className = ok?'ok':'err'; };
  const parseKey = (v)=>{ if(!v) return null; v=String(v).trim(); const m=v.match(/[?&]key=([^&#]+)/i); return m?decodeURIComponent(m[1]):v; };

  async function fetchTimeout(resource, options={}, ms=8000){
    const ctrl = new AbortController();
    const id = setTimeout(()=>ctrl.abort(), ms);
    try{
      const res = await fetch(resource, { ...options, signal: ctrl.signal });
      return res;
    } finally { clearTimeout(id); }
  }

  async function ownerAuthRobust(pot, key, code){
    const payload = { key: key||null, code: code||null };
    try{
      const r = await fetchTimeout(`${API}/pots/${encodeURIComponent(pot)}/owner/auth`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      if (r.ok) return r.json().catch(()=>({ok:true}));
    }catch(e){ console.warn('POST auth failed/timeout', e); }
    try{
      const r = await fetchTimeout(`${API}/pots/${encodeURIComponent(pot)}/owner/auth?key=${encodeURIComponent(key||'')}&code=${encodeURIComponent(code||'')}`, { method:'GET' });
      if (r.ok) return r.json().catch(()=>({ok:true}));
    }catch(e){ console.warn('GET auth failed/timeout', e); }
    try{
      const r = await fetchTimeout(`${API}/owner/auth?pot=${encodeURIComponent(pot)}&key=${encodeURIComponent(key||'')}&code=${encodeURIComponent(code||'')}`, { method:'GET' });
      if (r.ok) return r.json().catch(()=>({ok:true}));
    }catch(e){ console.warn('ALT auth failed/timeout', e); }
    throw new Error('Access denied');
  }

  let unsubscribe=null;
  function startLive(potId){
    try{ if(!firebase?.apps?.length) firebase.initializeApp(firebaseConfig); }catch(_){}
    const db=firebase.firestore();
    const box=$('entries');
    if(unsubscribe){ try{unsubscribe();}catch(_){ } unsubscribe=null; }
    box.innerHTML='<em>Loading…</em>';
    unsubscribe = db.collection('pots').doc(potId).collection('entries').onSnapshot(snap=>{
      const rows=[];
      snap.forEach(d=>{
        const e=d.data()||{};
        if(e.status && e.status!=='active') return;
        rows.push(`<tr data-id="${d.id}">
          <td>${(e.name||e.player_name||'').replace(/[<>]/g,'')}</td>
          <td>${(e.email||e.player_email||'').replace(/[<>]/g,'')}</td>
          <td>${e.member_type||'Member'}</td>
          <td><button class="paid-toggle" data-id="${d.id}">${e.paid?'Yes':'No'}</button></td>
        </tr>`);
      });
      box.innerHTML = `<table class="table">
        <thead><tr><th>Name</th><th>Email</th><th>Type</th><th>Paid</th></tr></thead>
        <tbody>${rows.join('')}</tbody>
      </table>`;
      box.querySelectorAll('.paid-toggle').forEach(btn=>{
        btn.onclick = async (ev)=>{
          const id = ev.currentTarget.getAttribute('data-id');
          const key = parseKey($('owner-key').value);
          const code = (($('owner-code').value||'').trim()||'').toUpperCase() || null;
          try{
            await fetch(`${API}/pots/${encodeURIComponent(potId)}/owner/entries/${encodeURIComponent(id)}/toggle-paid`, {
              method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({key, code})
            });
          }catch(e){ alert('Toggle failed'); console.error(e); }
        };
      });
    }, err=>{ console.error(err); box.innerHTML='<em>Error loading entries.</em>'; });
  }

  $('verify').onclick = async ()=>{
    const pot = ($('pot-id').value||'').trim();
    const key = parseKey($('owner-key').value);
    const code = (($('owner-code').value||'').trim()||'').toUpperCase() || null;
    if(!pot){ setMsg('Enter a Pot ID', false); return; }
    setMsg('Verifying...', true);
    try{
      await ownerAuthRobust(pot, key, code);
      setMsg('Access granted.', true);
      $('tools').classList.remove('hidden');
      $('potline').textContent = `Pot ID: ${pot}`;
      localStorage.setItem('mgr_auth', JSON.stringify({pot, key, code}));
      startLive(pot);
    }catch(e){
      setMsg('Access denied. Check credentials.', false);
      alert('Access denied');
    }
  };

  try{
    const q=new URLSearchParams(location.search);
    if(q.get('pot')) $('pot-id').value=q.get('pot');
    if(q.get('key')) $('owner-key').value=q.get('key');
  }catch(_){}
  try{
    const saved=JSON.parse(localStorage.getItem('mgr_auth')||'null');
    if(saved && saved.pot && (saved.key || saved.code)){
      $('pot-id').value=saved.pot;
      $('owner-key').value=saved.key || '';
      $('owner-code').value=saved.code || '';
      setTimeout(()=> $('verify').click(), 50);
    }
  }catch(_){}

})();
</script>
</body>
</html>
