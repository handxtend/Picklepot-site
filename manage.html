<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Organizer — Manage Pot</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f7f7fb;color:#111}
    .wrap{max-width:1000px;margin:40px auto;padding:0 16px}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.06);overflow:hidden}
    header{padding:20px 22px;border-bottom:1px solid #eee}
    header h1{margin:0;font-size:28px}
    .sec{padding:20px 22px}
    label{display:block;margin:10px 0 6px;color:#555}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #d8dbe2;font:inherit}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:#0d6efd;color:#fff;cursor:pointer}
    .btn.secondary{background:#111827}
    .btn.ghost{background:#eef2ff;color:#0d6efd}
    .btn.danger{background:#b91c1c}
    .hidden{display:none}
    .ok{color:#0a7a2e}
    .err{color:#b00020}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left}
    .muted{color:#6b7280}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#334155;margin:4px 6px 0 0;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr;} }
    .help{font-size:12px;color:#6b7280;margin-top:4px}
    .note{font-size:12px;color:#9ca3af;margin-left:6px}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = window.firebaseConfig || {
      apiKey:"AIzaSyA9QcJizDv1ibAPI7FV_NY8cMhkCjokzXE",
      authDomain:"pickle-pot.firebaseapp.com",
      projectId:"pickle-pot",
      storageBucket:"pickle-pot.appspot.com",
      messagingSenderId:"508555645160",
      appId:"1:508555645160:web:82e09803feb83d5150395d"
    };
    try{ if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
         firebase.auth().signInAnonymously().catch(()=>{});}catch(e){}
  </script>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <header>
      <h1>Organizer — Manage Pot</h1>
      <p class="muted">Unlock with the Owner Link or Owner Code. Update pot fields and manage entries below.</p>
    </header>

    <div class="sec">
      <label>Pot ID</label>
      <input id="pot-id" placeholder="e.g., abc123">
      <label>Owner Link Key (from manage URL)</label>
      <input id="owner-key" placeholder="paste &key=… or full manage link">
      <label>Owner Code (alternative auth)</label>
      <input id="owner-code" placeholder="e.g., 9X7BP">
      <div class="row" style="margin-top:10px"><button id="verify" class="btn">Verify Access</button><span id="status"></span><span id="manage-expiry-note" class="note" style="display:none;font-size:15px;margin-left:10px;">Pots expire 3 months (90 days) after creation.</span></div>
    </div>

    <div id="tools" class="sec hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="muted">Pot ID:</div>
          <div id="potline" class="pill"></div>
        </div>
        <div class="row">
          <button id="editToggle" class="btn ghost">Edit Pot</button>
          <button id="refreshPot" class="btn secondary">Refresh</button>
        </div>
      </div>

      <div id="potMeta" class="row" style="margin-top:8px;flex-wrap:wrap"></div>

      <div id="editForm" class="hidden" style="margin-top:14px">
        <div class="grid">
          <div>
            <label>Event / Name</label>
            <input id="f_event" placeholder="e.g., Men's Doubles 3.0-3.5">
          </div>
          <div>
            <label>Status</label>
            <select id="f_status">
              <option value="open">open</option>
              <option value="active">active</option>
              <option value="closed">closed</option>
            </select>
            <div class="help">New pots show in “Active Tournaments” when status is <b>open</b>.</div>
          </div>
          <div>
            <label>Date (YYYY-MM-DD)</label>
            <input id="f_date" placeholder="2025-09-28">
          </div>
          <div>
            <label>Skill</label>
            <input id="f_skill" placeholder="e.g., 3.0 - 3.5">
          </div>
          <div>
            <label>Location</label>
            <input id="f_location" placeholder="e.g., 123 Main St">
          </div>
          <div>
            <label>Organizer</label>
            <input id="f_organizer" placeholder="e.g., Pickleball Compete">
          </div>
          <div>
            <label>Organizer Email</label>
            <input id="f_organizer_email" type="email" placeholder="organizer@example.com">
          </div>
          <div>
            <label>Organizer Phone</label>
            <input id="f_organizer_phone" type="tel" placeholder="(555) 555-5555">
          </div>

          <div>
            <label>Buy-in (Member)</label>
            <input id="f_buyin_member" type="number" step="0.01" placeholder="10.00">
          </div>
          <div>
            <label>Buy-in (Guest)</label>
            <input id="f_buyin_guest" type="number" step="0.01" placeholder="10.00">
          </div>
          <div>
            <label>Pot Share %</label>
            <input id="f_pot_share_pct" type="number" step="1" min="0" max="100" placeholder="100">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <label><input type="checkbox" id="f_pay_cashapp"> Allow Cash App</label>
          <label><input type="checkbox" id="f_pay_zelle"> Allow Zelle</label>
          <label><input type="checkbox" id="f_pay_onsite"> Allow Onsite</label>
          <label class="muted"><input type="checkbox" id="f_pay_stripe" disabled> Stripe (disabled)</label>
          <span class="note">Stripe is disabled here as requested.</span>
        </div>
        <!-- Payment destination inputs (shown only when enabled) -->
        <div id="cashapp_info_wrap" class="row" style="margin-top:8px; display:none; flex-direction:column; align-items:flex-start">
          <label>Cash App Handle</label>
          <input id="f_pay_cashapp_str" placeholder="$YourCashtag (e.g., $PicklePotters)">
        </div>
        <div id="zelle_info_wrap" class="row" style="margin-top:8px; display:none; flex-direction:column; align-items:flex-start">
          <label>Zelle Address (email or phone)</label>
          <input id="f_pay_zelle_str" placeholder="you@example.com or (555) 555-5555">
        </div>


        <div class="row" style="margin-top:12px">
          <button id="savePot" class="btn">Save Changes</button>
          <button id="quickOpen" class="btn ghost">Set Status: open</button>
          <span id="saveStatus" class="muted"></span>
        </div>
      </div>

      <h3 style="margin:22px 0 8px">Entries</h3>
      <div id="entries"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const API = (window.API_BASE || 'https://picklepot-stripe.onrender.com').replace(/\/$/,'');
  const $ = (id)=>document.getElementById(id);
  const setMsg = (t, ok)=>{ const el=$('status'); el.textContent=t; el.className = ok?'ok':'err'; };
  const parseKey = (v)=>{ if(!v) return null; v=String(v).trim(); const m=v.match(/[?&]key=([^&#]+)/i); return m?decodeURIComponent(m[1]):v; };
  const db = firebase.firestore();
  let currentPot = null;
  let unsubscribe = null;
  let potSnapUnsub = null;

  async function fetchWithTimeout(url, options={}, ms=30000){
    const ctrl = new AbortController();
    const id = setTimeout(()=>ctrl.abort(), ms);
    try{
      const res = await fetch(url, {cache:'no-store', mode:'cors', credentials:'omit', ...options, signal: ctrl.signal});
      return res;
    } finally { clearTimeout(id); }
  }
  async function warmAPI(){ try{ await fetch(API+'/', { mode:'no-cors' }); }catch(_){ } }
  async function ownerAuthRobust(pot, key, code){
    const payload = { key: key||null, code: code||null };
    await warmAPI();
    try{
      const r = await fetchWithTimeout(`${API}/pots/${encodeURIComponent(pot)}/owner/auth`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      if (r.ok) return r.json().catch(()=>({ok:true}));
    }catch(e){ await new Promise(r=>setTimeout(r,700)); }
    try{
      const r = await fetchWithTimeout(`${API}/pots/${encodeURIComponent(pot)}/owner/auth?key=${encodeURIComponent(key||'')}&code=${encodeURIComponent(code||'')}`);
      if (r.ok) return r.json().catch(()=>({ok:true}));
    }catch(e){ await new Promise(r=>setTimeout(r,700)); }
    try{
      const r = await fetchWithTimeout(`${API}/owner/auth?pot=${encodeURIComponent(pot)}&key=${encodeURIComponent(key||'')}&code=${encodeURIComponent(code||'')}`);
      if (r.ok) return r.json().catch(()=>({ok:true}));
    }catch(e){}
    throw new Error('Access denied');
  }

  function renderMeta(d){
    const meta=$('potMeta'); meta.innerHTML='';
    const pills = [];
    if(d.event) pills.push(`<span class="pill">${(d.event+'').replace(/[<>]/g,'')}</span>`);
    if(d.location) pills.push(`<span class="pill">${(d.location+'').replace(/[<>]/g,'')}</span>`);
    if(d.skill) pills.push(`<span class="pill">Skill: ${(d.skill+'').replace(/[<>]/g,'')}</span>`);
    if(d.status) pills.push(`<span class="pill">Status: ${(d.status+'').replace(/[<>]/g,'')}</span>`);
    if(d.date) pills.push(`<span class="pill">Date: ${(d.date+'').replace(/[<>]/g,'')}</span>`);
    meta.innerHTML = pills.join('');
  }

  
  function togglePayInfo(){
    try{
      var cashWrap = document.getElementById('cashapp_info_wrap');
      var zelleWrap = document.getElementById('zelle_info_wrap');
      if(cashWrap) cashWrap.style.display = (document.getElementById('f_pay_cashapp')?.checked ? '' : 'none');
      if(zelleWrap) zelleWrap.style.display = (document.getElementById('f_pay_zelle')?.checked ? '' : 'none');
    }catch(_){}
  }

  function bindPotDoc(potId){
    if(potSnapUnsub){ try{potSnapUnsub();}catch(_){ } potSnapUnsub=null; }
    potSnapUnsub = db.collection('pots').doc(potId).onSnapshot(snap=>{
      if(!snap.exists) return;
      const d = snap.data()||{};
      renderMeta(d);
      $('f_event').value = d.event || '';
      $('f_status').value = (d.status||'open').toLowerCase();
      $('f_location').value = d.location || '';
      $('f_skill').value = d.skill || '';
      $('f_organizer').value = d.organizer || d.org || '';
      $('f_organizer_email').value = d.organizer_email || d.org_email || d.email || '';
      $('f_organizer_phone').value = d.organizer_phone || d.phone || '';
      $('f_date').value = d.date || '';
      $('f_buyin_member').value = d.buyin_member ?? '';
      $('f_buyin_guest').value = d.buyin_guest ?? '';
      $('f_pot_share_pct').value = d.pot_share_pct ?? '';
      var _fpm = $('f_payment_method'); if(_fpm) _fpm.value = d.payment_method || '';
      const pm = d.payment_methods || {};
      $('f_pay_cashapp').checked = !!(d.pay_cashapp ?? pm.cashapp);
      $('f_pay_zelle').checked   = !!(d.pay_zelle   ?? pm.zelle);
      $('f_pay_onsite').checked  = !!(d.pay_onsite  ?? pm.onsite);
      $('f_pay_stripe').checked  = false; // disabled
      var _cashStr = document.getElementById('f_pay_cashapp_str'); if(_cashStr) _cashStr.value = d.pay_cashapp_str || d.pay_cashapp || '';
      var _zelleStr = document.getElementById('f_pay_zelle_str'); if(_zelleStr) _zelleStr.value = d.pay_zelle_str || d.pay_zelle || '';
      togglePayInfo();
    });
  }

  function startLive(potId){
    if(unsubscribe){ try{unsubscribe();}catch(_){ } unsubscribe=null; }
    const box=$('entries');
    box.innerHTML='<em>Loading…</em>';
    unsubscribe = db.collection('pots').doc(potId).collection('entries').onSnapshot(snap=>{
      const rows=[];
      snap.forEach(d=>{
        const e=d.data()||{};
        if(e.status && e.status!=='active') return;
        rows.push(`<tr data-id="${d.id}">
          <td>${(e.name||e.player_name||'').replace(/[<>]/g,'')}</td>
          <td>${(e.email||e.player_email||'').replace(/[<>]/g,'')}</td>
          <td>${e.member_type||'Member'}</td>
          <td>
            <span class="pill" style="background:${e.paid?'#dcfce7':'#fee2e2'};color:${e.paid?'#166534':'#7f1d1d'}">${e.paid?'Yes':'No'}</span>
            <button class="btn ghost btn-paid" data-id="${d.id}" data-paid="${!!e.paid}">${e.paid?'Mark Unpaid':'Mark Paid'}</button>
          </td>
          <td><button class="btn danger btn-remove" data-id="${d.id}">Remove</button></td>
        </tr>`);
      });
      box.innerHTML = `<table class="table">
        <thead><tr><th>Name</th><th>Email</th><th>Type</th><th>Paid</th><th>Actions</th></tr></thead>
        <tbody>${rows.join('')}</tbody>
      </table>`;

      box.querySelectorAll('.btn-remove').forEach(btn=>{
        btn.onclick = async (ev)=>{
          const id = ev.currentTarget.getAttribute('data-id');
          if(!confirm('Remove this player from the pot?')) return;
          try{
            await db.collection('pots').doc(potId).collection('entries').doc(id).delete();
          }catch(e){ alert('Remove failed'); console.error(e); }
        };
      });
      box.querySelectorAll('.btn-paid').forEach(btn=>{
        btn.onclick = async (ev)=>{
          const id = ev.currentTarget.getAttribute('data-id');
          const paidNow = ev.currentTarget.getAttribute('data-paid') === 'true';
          try{
            await db.collection('pots').doc(potId).collection('entries').doc(id).update({ paid: !paidNow });
          }catch(e){ alert('Update failed'); console.error(e); }
        };
      });
    }, err=>{ console.error(err); box.innerHTML='<em>Error loading entries.</em>'; });
  }

  $('verify').onclick = async ()=>{
    const pot = ($('pot-id').value||'').trim();
    const key = parseKey($('owner-key').value);
    const code = (($('owner-code').value||'').trim()||'').toUpperCase() || null;
    if(!pot){ setMsg('Enter a Pot ID', false); return; }
    setMsg('Verifying...', true);
    try{
      await ownerAuthRobust(pot, key, code);
      setMsg('Access granted.', true);
      
      try{ var n = document.getElementById('manage-expiry-note'); if(n) n.style.display='inline'; }catch(_){}
$('tools').classList.remove('hidden');
      try{
        document.getElementById('f_pay_cashapp').addEventListener('change', togglePayInfo);
        document.getElementById('f_pay_zelle').addEventListener('change', togglePayInfo);
        togglePayInfo();
      }catch(_){ }

      $('potline').textContent = pot;
      localStorage.setItem('mgr_auth', JSON.stringify({pot, key, code}));
      currentPot = pot;
      startLive(pot);
      bindPotDoc(pot);
    }catch(e){
      setMsg('Access denied. Check credentials.', false);
      alert('Access denied');
    }
  };

  $('refreshPot').onclick = ()=>{
    if(currentPot){ startLive(currentPot); bindPotDoc(currentPot); }
  };

  $('editToggle').onclick = ()=>{
    $('editForm').classList.toggle('hidden');
  };

  $('savePot').onclick = async ()=>{
    if(!currentPot) return;
    $('saveStatus').textContent = 'Saving…';
    const updates = {
      event: $('f_event').value.trim(),
      status: $('f_status').value.trim().toLowerCase(),
      location: $('f_location').value.trim(),
      organizer: $('f_organizer').value.trim(),
      organizer_email: $('f_organizer_email').value.trim(),
      organizer_phone: $('f_organizer_phone').value.trim(),
      date: $('f_date').value.trim(),
      skill: $('f_skill').value.trim(),
      buyin_member: parseFloat($('f_buyin_member').value) || 0,
      buyin_guest: parseFloat($('f_buyin_guest').value) || 0,
      pot_share_pct: parseFloat($('f_pot_share_pct').value) || 0,
      payment_method: (function(){var el=$('f_payment_method');return el?el.value.trim():'';})(),
      pay_cashapp_str: (document.getElementById('f_pay_cashapp_str')||{}).value ? document.getElementById('f_pay_cashapp_str').value.trim() : '',
      pay_zelle_str:   (document.getElementById('f_pay_zelle_str')||{}).value   ? document.getElementById('f_pay_zelle_str').value.trim()   : '',
      pay_cashapp: $('f_pay_cashapp').checked,
      pay_zelle: $('f_pay_zelle').checked,
      pay_onsite: $('f_pay_onsite').checked,
      payment_methods: {
        cashapp: $('f_pay_cashapp').checked,
        zelle: $('f_pay_zelle').checked,
        onsite: $('f_pay_onsite').checked,
        stripe: false
      }
    };
    try{
      await db.collection('pots').doc(currentPot).update(updates);
      $('saveStatus').textContent = 'Saved.';
      setTimeout(()=>$('saveStatus').textContent='', 2000);
    }catch(e){
      console.error(e);
      $('saveStatus').textContent = 'Save failed.';
    }
  };

  $('quickOpen').onclick = async ()=>{
    if(!currentPot) return;
    try{ await db.collection('pots').doc(currentPot).update({ status:'open' }); }catch(e){}
  };

  // Restore from URL/localStorage
  try{
    const q=new URLSearchParams(location.search);
    if(q.get('pot')) $('pot-id').value=q.get('pot');
    if(q.get('key')) $('owner-key').value=q.get('key');
  }catch(_){}
  try{
    const saved=JSON.parse(localStorage.getItem('mgr_auth')||'null');
    if(saved && saved.pot && (saved.key || saved.code)){
      $('pot-id').value=saved.pot;
      $('owner-key').value=saved.key || '';
      $('owner-code').value=saved.code || '';
      setTimeout(()=> $('verify').click(), 80);
    }
  }catch(_){}

})();
</script>
</body>
</html>
