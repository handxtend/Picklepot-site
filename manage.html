<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Manage Pot</title>
  <style>
    :root{--ink:#111827;--muted:#6b7280;--line:#e5e7eb;--bg:#f9fafb;--ok:#16a34a;--bad:#b91c1c;--blue:#0ea5e9;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:24px;color:var(--ink)}
    .wrap{max-width:1000px;margin:0 auto}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.06);padding:20px 22px}
    h1{margin:0 0 8px;font-size:22px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    th{font-weight:600}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--line);font-size:.85rem}
    .pill.ok{background:#ecfdf5;border-color:#A7F3D0;color:#065F46}
    .pill.bad{background:#FEF2F2;border-color:#FECACA;color:#7F1D1D}
    .row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;margin:.5rem 0}
    input[type="number"], input[type="text"], select{padding:.5rem;border:1px solid var(--line);border-radius:10px;min-width:120px}
    button{border:1px solid var(--ink);background:#111827;color:#fff;border-radius:10px;padding:.5rem .8rem;cursor:pointer}
    button.ghost{background:#fff;color:var(--ink)}
    .grid{display:grid;grid-template-columns:1fr auto;gap:1rem;align-items:center}
    a{color:var(--blue);text-decoration:none}
    a:hover{text-decoration:underline}
    .topnav{display:flex;gap:.5rem;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    .btnrow{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    code{background:#f3f4f6;padding:2px 6px;border-radius:8px}
    .right{margin-left:auto}
    @media (max-width:700px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topnav">
        <div>
          <h1 style="display:inline">Organizer – Manage Pot</h1>
          <span id="meta" class="muted" style="margin-left:.5rem"></span>
        </div>
        <div class="btnrow">
          <button id="copyLink" class="ghost">Copy Organizer Link</button>
          <button id="copyEmails" class="ghost">Copy Emails</button>
          <button id="exportCsv" class="ghost">Export CSV</button>
          <button id="refresh" class="ghost">Refresh</button>
          <a href="/" class="muted right">Back to Home</a>
        </div>
      </div>

      <!-- Manual payment tools -->
      <div class="row" style="margin-top:.25rem">
        <strong>Manual payment:</strong>
        <select id="method">
          <option value="cash">Cash</option>
          <option value="zelle">Zelle</option>
          <option value="cashapp">Cash App</option>
          <option value="other">Other</option>
        </select>
        <label>Amount (¢):</label>
        <input id="amount" type="number" min="0" step="50" value="2000"/>
        <input id="note" type="text" placeholder="note (optional)" style="flex:1;min-width:200px"/>
      </div>

      <!-- Add manual entry -->
      <div class="row" style="margin:.25rem 0 0">
        <strong>Add entry:</strong>
        <input id="newName" type="text" placeholder="Name (optional)" style="min-width:180px"/>
        <input id="newEmail" type="text" placeholder="Email (optional)" style="min-width:220px"/>
        <button id="addEntry" class="ghost">Add Entry</button>
        <small class="muted">Tip: add then mark PAID if they paid onsite/Zelle/Cash App.</small>
      </div>

      <!-- Filters -->
      <div class="row" style="margin:.25rem 0 0">
        <strong>Filter:</strong>
        <input id="q" type="text" placeholder="search name or email" style="min-width:240px"/>
        <select id="status">
          <option value="all">All</option>
          <option value="paid">Paid</option>
          <option value="unpaid">Unpaid</option>
        </select>
      </div>

      <div class="grid" style="margin-top:.5rem">
        <h3 style="margin:0">Entries</h3>
      </div>

      <table id="tbl">
        <thead>
          <tr><th>Player</th><th>Email</th><th>Status</th><th>Action</th></tr>
        </thead>
        <tbody id="rows"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
      </table>
    </div>
  </div>

<script>
// -------- Config & params --------
const API_BASE = window.API_BASE || 'https://picklepot-stripe.onrender.com';
const qs = new URLSearchParams(location.search);
const pot = qs.get('pot');
const key = qs.get('key');

// -------- DOM --------
const $meta = document.getElementById('meta');
const $rows = document.getElementById('rows');
const $method = document.getElementById('method');
const $amount = document.getElementById('amount');
const $note = document.getElementById('note');
const $refresh = document.getElementById('refresh');
const $exportCsv = document.getElementById('exportCsv');
const $copyLink = document.getElementById('copyLink');
const $copyEmails = document.getElementById('copyEmails');
const $q = document.getElementById('q');
const $status = document.getElementById('status');
const $newName = document.getElementById('newName');
const $newEmail = document.getElementById('newEmail');
const $addEntry = document.getElementById('addEntry');

let ALL_ENTRIES = [];

if (!pot || !key) {
  $meta.innerHTML = '<span class="pill bad">Missing pot/key</span> Add <code>?pot=...&key=...</code> to this URL.';
} else {
  $meta.innerHTML = 'Pot <code>'+pot+'</code>';
  loadEntries();
}

$refresh.addEventListener('click', loadEntries);
$copyLink.addEventListener('click', () => copyToClipboard(location.href));
$copyEmails.addEventListener('click', copyAllEmails);
$exportCsv.addEventListener('click', exportCsv);
$q.addEventListener('input', applyFilters);
$status.addEventListener('change', applyFilters);
$addEntry.addEventListener('click', addManualEntry);

// -------- Data --------
async function loadEntries(){
  $rows.innerHTML = '<tr><td colspan="4" class="muted">Loading…</td></tr>';
  try{
    const res = await fetch(`${API_BASE}/pots/${encodeURIComponent(pot)}/entries?key=${encodeURIComponent(key)}`);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    ALL_ENTRIES = Array.isArray(data.entries) ? data.entries : [];
    applyFilters();
  }catch(err){
    console.error(err);
    $rows.innerHTML = '<tr><td colspan="4" class="muted">Failed to load. Try refresh.</td></tr>';
  }
}

function applyFilters(){
  const needle = ($q.value || '').toLowerCase().trim();
  const st = $status.value;
  let list = ALL_ENTRIES.slice();
  if (needle){
    list = list.filter(e => (e.name||e.player||'').toLowerCase().includes(needle) || (e.email||'').toLowerCase().includes(needle));
  }
  if (st === 'paid') list = list.filter(e => !!e.paid);
  if (st === 'unpaid') list = list.filter(e => !e.paid);

  if(list.length === 0){
    $rows.innerHTML = '<tr><td colspan="4" class="muted">No matching entries.</td></tr>';
    return;
  }
  $rows.innerHTML = list.map(renderRow).join('');
  // Attach handlers
  list.forEach(e => {
    const btn1 = document.getElementById('p_'+e.id);
    const btn0 = document.getElementById('u_'+e.id);
    if (btn1) btn1.addEventListener('click', () => markPaid(e.id));
    if (btn0) btn0.addEventListener('click', () => unmark(e.id));
  });
}

// -------- UI helpers --------
function renderRow(e){
  const status = e.paid ? '<span class="pill ok">PAID</span>' : '<span class="pill bad">UNPAID</span>';
  const actions = e.paid
    ? `<button id="u_${e.id}" class="ghost">Undo</button>`
    : `<button id="p_${e.id}">Mark PAID</button>`;
  const name = e.name || e.player || e.email || '-';
  const email = e.email || '';
  return `<tr><td>${escapeHTML(name)}</td><td>${escapeHTML(email)}</td><td>${status}</td><td>${actions}</td></tr>`;
}

function copyToClipboard(text){
  try{
    navigator.clipboard.writeText(text);
    toast('Link copied');
  }catch(_){
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    toast('Link copied');
  }
}

function toast(msg){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.cssText = 'position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:8px 12px;border-radius:10px;opacity:.96;z-index:9999';
  document.body.appendChild(el);
  setTimeout(()=>{ el.remove(); }, 1400);
}

// -------- Actions --------
async function markPaid(entryId){
  const body = {
    amount_cents: parseInt($amount.value||'0',10)||0,
    method: $method.value,
    note: ($note.value||'').slice(0,120)
  };
  try{
    const res = await fetch(`${API_BASE}/pots/${encodeURIComponent(pot)}/entries/${encodeURIComponent(entryId)}/mark-paid-manual?key=${encodeURIComponent(key)}`,{
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    await loadEntries();
  }catch(err){ alert('Failed to mark paid'); console.error(err); }
}

async function unmark(entryId){
  try{
    const res = await fetch(`${API_BASE}/pots/${encodeURIComponent(pot)}/entries/${encodeURIComponent(entryId)}/unmark-paid?key=${encodeURIComponent(key)}`,{
      method:'POST'
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    await loadEntries();
  }catch(err){ alert('Failed to undo'); console.error(err); }
}

async function addManualEntry(){
  const name = ($newName.value || '').trim();
  const email = ($newEmail.value || '').trim();
  if (!name && !email){
    alert('Enter a name or an email.');
    return;
  }
  // Light email check
  if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    if (!confirm('Email looks unusual. Add anyway?')) return;
  }

  const body = { name, email };
  const endpoints = [
    `${API_BASE}/pots/${encodeURIComponent(pot)}/entries/add-manual?key=${encodeURIComponent(key)}`,
    `${API_BASE}/pots/${encodeURIComponent(pot)}/owner-add-entry?key=${encodeURIComponent(key)}`
  ];

  let ok = false, lastErr = null;
  for (const url of endpoints){
    try{
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      if (res.ok){ ok = true; break; }
      lastErr = 'HTTP '+res.status;
    }catch(e){ lastErr = e.message; }
  }
  if (!ok){
    alert('Add entry failed. Please update the backend to support /entries/add-manual or /owner-add-entry.\nLast error: '+(lastErr||''));
    return;
  }
  $newName.value = ''; $newEmail.value = '';
  await loadEntries();
}

function copyAllEmails(){
  const emails = Array.from(new Set(ALL_ENTRIES.map(e => (e.email||'').trim()).filter(Boolean)));
  if (!emails.length){ alert('No emails to copy'); return; }
  copyToClipboard(emails.join(', '));
  toast('Emails copied');
}

// -------- CSV --------
function exportCsv(){
  if (!ALL_ENTRIES.length){ alert('No entries to export'); return; }
  const list = collectVisibleRows();
  const rows = list.length ? list : ALL_ENTRIES;
  const head = ['id','name','email','paid'];
  const lines = [head.join(',')].concat(rows.map(e => [
    csv(e.id), csv(e.name || e.player || ''), csv(e.email || ''), csv(e.paid ? 'yes' : 'no')
  ].join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `pot-${pot}-entries.csv`; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

function collectVisibleRows(){
  const needle = ($q.value || '').toLowerCase().trim();
  const st = $status.value;
  let list = ALL_ENTRIES.slice();
  if (needle){
    list = list.filter(e => (e.name||e.player||'').toLowerCase().includes(needle) || (e.email||'').toLowerCase().includes(needle));
  }
  if (st === 'paid') list = list.filter(e => !!e.paid);
  if (st === 'unpaid') list = list.filter(e => !e.paid);
  return list;
}

function csv(v){
  const s = String(v==null?'':v);
  if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

// -------- Utils --------
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }
</script>
</body>
</html>
