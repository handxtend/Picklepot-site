<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment Successful — Pot Created</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    body { padding: 2rem; }
    .card { max-width: 840px; margin: 0 auto; }
    code.k { user-select: all; padding: .25rem .5rem; background: #f3f4f6; border-radius: 6px; }
    .muted { color: #6b7280; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <article class="card">
    <header>
      <h2>Payment Successful</h2>
      <p class="muted">Your tournament is being created. The organizer link and owner code will appear below once ready.</p>
    </header>

    <section id="status">
      <progress id="bar" value="0" max="100"></progress>
      <p id="msg" class="muted mono">Preparing results…</p>
      <div id="details" hidden>
        <p><strong>Pot ID:</strong> <span id="potId" class="mono"></span></p>
        <p><strong>Owner code:</strong> <code id="ownerCode" class="k"></code></p>
        <p>
          <a id="openManage" class="contrast" role="button" href="#" target="_blank">Open Organizer Manage Page</a>
        </p>
      </div>
    </section>

    <footer>
      <a href="/index.html" role="button" class="secondary">Back to Home</a>
    </footer>
  </article>

  <script>
    const qs = new URLSearchParams(location.search);
    const sessionId = qs.get("session_id");
    const flow = qs.get("flow") || "create";
    const backend = (window.PP_BACKEND || "https://picklepot-stripe.onrender.com").replace(/\/$/,"");

    const msg = document.getElementById("msg");
    const bar = document.getElementById("bar");
    const details = document.getElementById("details");
    const potIdEl = document.getElementById("potId");
    const ownerCodeEl = document.getElementById("ownerCode");
    const openBtn = document.getElementById("openManage");

    async function check() {
      try {
        const res = await fetch(`${backend}/create-status?session_id=${encodeURIComponent(sessionId)}`, {credentials:"include"});
        if (res.status === 404) {
          // not found endpoint (older backend) — keep trying but show hint
          msg.textContent = "Waiting for tournament to be created…";
          return false;
        }
        const data = await res.json();
        if (!data.ready) return false;
        const r = data.results && data.results[0];
        if (!r) return false;

        potIdEl.textContent = r.pot_id || "";
        ownerCodeEl.textContent = r.owner_code || "";
        openBtn.href = r.manage_url || "#";
        details.hidden = false;
        bar.value = bar.max;
        msg.textContent = "Done!";
        return true;
      } catch (e) {
        console.warn("status poll error", e);
        return false;
      }
    }

    let t = 0;
    async function loop() {
      const ok = await check();
      if (ok) return;
      t = Math.min(100, t + 2);
      bar.value = t;
      setTimeout(loop, 1500);
    }

    if (sessionId) loop();
    else { msg.textContent = "Missing session_id in the URL."; }
  </script>
</body>
</html>
