<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Payment Successful — Pot Create</title>
    <link rel="icon" href="logo.png">
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f8fb;margin:0}
      .card{max-width:720px;margin:48px auto;padding:28px 32px;background:#fff;border-radius:14px;box-shadow:0 6px 26px rgba(16,24,40,.08)}
      h1{margin:0 0 10px 0;font-size:28px}
      p{color:#475467;margin:8px 0 18px}
      .btns{display:flex;gap:10px;margin-top:12px}
      .btn{background:#16a34a;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
      .subtle{background:#e5e7eb;color:#111827}
      .result{margin-top:18px;padding:12px 14px;border-radius:10px;background:#f3faf4;border:1px solid #d1fadf}
      code{background:#111827;color:#fff;padding:.2rem .45rem;border-radius:.4rem}
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Payment Successful</h1>
      <p>Your tournament is being created. The organizer link and owner code will appear below once ready.</p>
      <div id="status" class="result">Preparing results…</div>
      <div class="btns">
        <a class="btn subtle" href="index.html">Back to Home</a>
        <a id="openManage" class="btn" href="#" style="display:none" target="_blank" rel="noopener">Open Organizer Manage Page</a>
      </div>
    </div>
    <script>
      const BACKEND = (location.hostname.includes('localhost') ?
        (localStorage.getItem('dev_backend') || 'http://127.0.0.1:8000') :
        'https://picklepot-stripe.onrender.com');

      const params = new URLSearchParams(location.search);
      const sessionId = params.get('session_id');

      const $status = document.getElementById('status');
      const $open = document.getElementById('openManage');

      async function poll() {
        if(!sessionId){
          $status.textContent = 'Missing session id.';
          return;
        }
        try{
          const r = await fetch(`${BACKEND}/create-status?session_id=${encodeURIComponent(sessionId)}`, {credentials:'omit'});
          if(!r.ok){ throw new Error('not ready'); }
          const j = await r.json();
          if(!j.ready){ $status.textContent = 'Still preparing results… retrying…'; setTimeout(poll, 1400); return; }
          if(!j.results || !j.results.length){ $status.textContent = 'No results found yet. Retrying…'; setTimeout(poll, 1400); return; }
          const first = j.results[0];
          $status.innerHTML = `
            <div><strong>Pot ID:</strong> <code>${first.pot_id || '(unknown)'}</code></div>
            <div><strong>Owner code:</strong> <code>${first.owner_code || '(hidden)'}</code></div>
            <div style="margin-top:8px"><a href="${first.manage_url}" target="_blank" rel="noopener">Manage link</a></div>`;
          $open.style.display = 'inline-block';
          $open.href = first.manage_url;
        }catch(e){
          console.warn(e);
          $status.textContent = 'Waiting for webhook… retrying…';
          setTimeout(poll, 1400);
        }
      }
      poll();
    </script>
  </body>
</html>