<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment Successful — Organizer Links</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f8fafc;color:#0f172a;margin:0}
    .wrap{max-width:760px;margin:10vh auto;padding:24px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:24px}
    .btn{display:inline-block;margin-top:14px;padding:10px 14px;border-radius:10px;background:#16a34a;color:#fff;text-decoration:none}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px}
    ul{padding-left:18px}
    .warn{color:#b45309}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Payment Successful</h1>
      <p>Your tournament is being created. The organizer link and owner code will appear below once ready.</p>
      <div id="result" class="warn">Loading…</div>
      <a class="btn" href="./">Back to Home</a>
      <a class="btn" href="./manage.html">Open Organizer Manage Page</a>
    </div>
  </div>
  <script>
  (function(){
    const API_BASE = 'https://picklepot-stripe.onrender.com'; // your Render backend
    const params = new URLSearchParams(location.search);
    const sid = params.get('session_id');
    const out = document.getElementById('result');

    if(!sid){
      out.innerHTML = 'Missing <code>session_id</code> in URL. This page only works when you come from Stripe and the success_url includes <code>?session_id={CHECKOUT_SESSION_ID}</code>.';
      return;
    }

    async function fetchResult(){
      try{
        const r = await fetch(API_BASE + '/create-result?session_id=' + encodeURIComponent(sid));
        if(!r.ok){ out.textContent = 'Still preparing results… retrying…'; setTimeout(fetchResult, 2500); return; }
        const data = await r.json();
        const pots = (data && data.pots) || [];
        if(!pots.length){ out.textContent = 'No pots returned yet. Retrying…'; setTimeout(fetchResult, 2500); return; }
        const ul = document.createElement('ul');
        pots.forEach((p,i)=>{
          const li = document.createElement('li');
          li.innerHTML = '<strong>Pot ' + (i+1) + '</strong> — <a href="'+p.manage_url+
                         '" target="_blank" rel="noopener">Open Organizer Manage</a> &nbsp;|&nbsp; Owner code: <code>'+p.owner_code+'</code>';
          ul.appendChild(li);
        });
        out.innerHTML = ''; out.appendChild(ul);
      }catch(e){ out.textContent = e.message || 'Could not load results.'; }
    }
    fetchResult();
  })();
  </script>
</body>
</html>
